<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schedl Munkaruha - Nyilv√°ntart√°s (FIFO + T√∂rl√©s)</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --panel: #ffffff;
      --primary: #0f5fa8;
      --border: #e5e7eb;
      --text: #1f2937;
      --muted: #6b7280;
      --danger: #b91c1c;
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    /* K√©perny≈ë n√©zet elemek */
    header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      text-align: center;
      font-weight: 700;
      font-size: 18px;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    button:hover { background: #08467c; }
    input, select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
    }
    .hidden { display: none !important; }

    /* Login */
    #login-screen {
      max-width: 380px;
      margin: 60px auto;
      background: var(--panel);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
    }
    #login-screen h2 { margin-top: 0; color: var(--primary); }
    #login-error { color: var(--danger); margin-top: 10px; font-weight: bold; }
    #login-password { width: 100%; margin: 10px 0; padding: 10px; }
    #login-screen button { width: 100%; padding: 10px; font-size: 16px; }

    /* Tabs */
    .tabs {
      display: flex;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      gap: 2px;
      padding: 0 10px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { background: #f9fafb; color: var(--text); }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: #eef4fb;
    }

    /* Panelek */
    .tab-content {
      background: var(--panel);
      margin: 16px;
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      min-height: 400px;
    }
    h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 8px; }

    /* T√°bl√°zat */
    .table-container { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13.5px;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px 6px;
      text-align: center;
    }
    th {
      background: #f8fafc;
      font-weight: 600;
      position: relative;
      padding-right: 20px; /* hely a sz≈±r≈ë ny√≠lnak */
      cursor: default;
      user-select: none;
    }
    tr.low-stock { background: #ffe4e6; }
    
    .danger-btn {
      background: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }
    .danger-btn:hover { background: #fecaca; }

    .disabled-btn {
        background: #e5e7eb;
        color: #9ca3af;
        border: 1px solid #d1d5db;
        cursor: not-allowed;
    }
    .disabled-btn:hover { background: #e5e7eb; }

    .filters-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
      background: #f9fafb;
      padding: 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    /* Sz≈±r≈ë dropdown */
    .filter-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 10px;
      color: #4b5563;
      position: absolute;
      right: 2px;
      top: 50%;
      transform: translateY(-50%);
      padding: 4px;
      border-radius: 4px;
    }
    .filter-btn:hover { background: rgba(15,95,168,0.1); }
    
    .filter-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      padding: 8px;
      z-index: 9999;
      max-height: 250px;
      overflow-y: auto;
      min-width: 180px;
      text-align: left;
    }
    .filter-dropdown label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin: 4px 0;
      cursor: pointer;
      white-space: nowrap;
    }
    .filter-actions {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
      justify-content: space-between;
    }
    .filter-actions button {
      padding: 4px 8px;
      font-size: 11px;
    }
    .btn-secondary { background: #9ca3af; }
    .btn-secondary:hover { background: #6b7280; }
    .btn-outline { background: transparent; color: var(--text); border: 1px solid #d1d5db; }
    .btn-outline:hover { background: #f3f4f6; }

    /* NYOMTAT√ÅS */
    #print-area { display: none; }

    /* IDEIGLENES PARANCS DOBOZ ST√çLUSA */
    #temp-commands {
      background-color: #1e1e1e;
      color: #00ff00;
      font-family: monospace;
      padding: 15px;
      margin: 20px auto;
      max-width: 800px;
      border-radius: 8px;
      overflow-x: auto;
      border: 2px solid #333;
    }
    #temp-commands h4 {
      color: #ffffff;
      margin-top: 0;
      margin-bottom: 10px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    #temp-commands p {
      margin: 5px 0;
      white-space: pre-wrap;
    }

    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #temp-commands { display: none !important; } /* Ne nyomtassa ki a parancsokat */
      #print-area {
        display: block !important;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
        background: white;
        color: black;
      }
      .print-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid black;
        padding-bottom: 10px;
      }
      .print-header h1 { margin: 0; font-size: 24px; font-family: serif; }
      .print-header p { margin: 5px 0 0 0; font-size: 14px; color: #555; }
      
      .print-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-family: serif;
        font-size: 16px;
      }

      .print-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 40px;
      }
      .print-table th, .print-table td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
        font-size: 14px;
        font-family: serif;
      }
      .print-table th { background: #eee !important; -webkit-print-color-adjust: exact; }

      .print-footer {
        display: flex;
        justify-content: space-between;
        margin-top: 60px;
        font-family: serif;
      }
      .signature-box {
        text-align: center;
        width: 40%;
      }
      .signature-line {
        border-top: 1px solid black;
        margin-top: 40px;
        padding-top: 5px;
        font-weight: bold;
      }
    }
  </style>
</head>
<body>

<header>Schedl Munkaruha - Nyilv√°ntart√°s (FIFO)</header>

<!-- IDEIGLENES PARANCSOK MEGJELEN√çT√âSE -->
<div id="temp-commands">
  <h4>Ideiglenes Linux parancsok a HP ThinPro Wi-Fi jav√≠t√°s√°hoz (Root termin√°lba):</h4>
  <p>echo "deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse" >> /etc/apt/sources.list</p>
  <p>echo "deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list</p>
  <p>echo "deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list</p>
  <p>apt-get update</p>
  <p>apt-get install -y build-essential git dkms linux-headers-$(uname -r)</p>
  <p>git clone https://github.com/morrownr/88x2bu-20210702.git</p>
  <p>cd 88x2bu-20210702</p>
  <p>make</p>
  <p>make install</p>
  <p>modprobe 88x2bu</p>
</div>

<!-- BEL√âP√âS -->
<div id="login-screen">
  <h2>Rendszer Bel√©p√©s</h2>
  <label for="login-password">Add meg a jelsz√≥t:</label>
  <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter') login()">
  <button onclick="login()">Bel√©p√©s</button>
  <p id="login-error" class="hidden">Hib√°s jelsz√≥!</p>
</div>

<!-- APP -->
<div id="main-app" class="hidden">

  <div class="tabs">
    <div class="tab active" onclick="showTab('income')">Bev√©tel</div>
    <div class="tab" onclick="showTab('expense')">Kiad√°s</div>
    <div class="tab" onclick="showTab('inventory')">K√©szlet</div>
    <div class="tab" onclick="showTab('receipts')">Sz√°ml√°k (Rakt√°ron)</div>
    <div class="tab" onclick="showTab('products')">Term√©kek</div>
    <div class="tab" onclick="showTab('employees')">Dolgoz√≥k</div>
    <div class="tab" onclick="showTab('movements')">Mozg√°sok / Bizonylat</div>
    <div class="tab" id="backup-tab" onclick="showTab('backup')">Backup</div>
  </div>

  <!-- BEV√âTEL -->
  <div id="income" class="tab-content">
    <h3>Bev√©tel r√∂gz√≠t√©se (Sz√°mla szerint)</h3>
    <div class="filters-row">
      <input id="income-receipt" type="text" placeholder="Sz√°mla sz√°ma" style="width:150px; border-color:var(--primary);">
      <select id="income-type" style="min-width:150px"></select>
      <select id="income-size" style="min-width:100px"></select>
      <input id="income-qty" type="number" min="1" value="1" style="width:80px;" placeholder="Db">
      <button onclick="addIncome()">+ Hozz√°ad</button>
    </div>
    <h4>Aktu√°lis k√©szlet (√ñsszes√≠tett)</h4>
    <div class="table-container">
      <table id="income-inventory-table">
        <thead>
          <tr>
            <th data-col="type">T√≠pus <button class="filter-btn" onclick="openFilter('income-inventory-table','type',event)">‚ñº</button></th>
            <th data-col="size">M√©ret <button class="filter-btn" onclick="openFilter('income-inventory-table','size',event)">‚ñº</button></th>
            <th data-col="qty">Darab</th>
            <th data-col="min">Minimum</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- KIAD√ÅS -->
  <div id="expense" class="tab-content hidden">
    <h3>Kiad√°s r√∂gz√≠t√©se (FIFO: Legr√©gebbi sz√°ml√°r√≥l)</h3>
    <div class="filters-row">
      <select id="employee-select" style="min-width:180px"></select>
      <select id="expense-type" style="min-width:150px"></select>
      <select id="expense-size" style="min-width:100px"></select>
      <input id="expense-qty" type="number" min="1" value="1" style="width:80px;" placeholder="Db">
      <button onclick="addExpense()">Kiad√°s r√∂gz√≠t√©se</button>
    </div>
    <h4>Aktu√°lis k√©szlet</h4>
    <div class="table-container">
      <table id="expense-inventory-table">
        <thead>
          <tr>
            <th data-col="type">T√≠pus <button class="filter-btn" onclick="openFilter('expense-inventory-table','type',event)">‚ñº</button></th>
            <th data-col="size">M√©ret <button class="filter-btn" onclick="openFilter('expense-inventory-table','size',event)">‚ñº</button></th>
            <th data-col="qty">K√©szlet</th>
            <th data-col="min">Limit</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- K√âSZLET -->
  <div id="inventory" class="tab-content hidden">
    <h3>Teljes K√©szlet (√ñsszes√≠tett)</h3>
    <div class="filters-row">
      <button onclick="exportInventory()">Export√°l√°s Excelbe</button>
    </div>
    <div class="table-container">
      <table id="inventory-table">
        <thead>
          <tr>
            <th data-col="type">T√≠pus <button class="filter-btn" onclick="openFilter('inventory-table','type',event)">‚ñº</button></th>
            <th data-col="size">M√©ret <button class="filter-btn" onclick="openFilter('inventory-table','size',event)">‚ñº</button></th>
            <th data-col="qty">Darab</th>
            <th data-col="min">Minimum</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- SZ√ÅML√ÅK (√öJ F√úL) -->
  <div id="receipts" class="tab-content hidden">
    <h3>Rakt√°ron l√©v≈ë t√©telek sz√°ml√°k szerint</h3>
    <p>Itt l√°that√≥, hogy melyik sz√°ml√°r√≥l mennyi darab van m√©g <b>rakt√°ron</b> (ami m√©g nem lett kiadva).</p>
    <div class="filters-row">
        <!-- Ide j√∂hetne export gomb, ha kell -->
    </div>
    <div class="table-container">
      <table id="receipts-table">
        <thead>
          <tr>
            <th data-col="receipt">Sz√°mla sz√°ma <button class="filter-btn" onclick="openFilter('receipts-table','receipt',event)">‚ñº</button></th>
            <th data-col="type">T√≠pus <button class="filter-btn" onclick="openFilter('receipts-table','type',event)">‚ñº</button></th>
            <th data-col="size">M√©ret <button class="filter-btn" onclick="openFilter('receipts-table','size',event)">‚ñº</button></th>
            <th data-col="qty">Marad√©k db</th>
            <th data-col="date">Be√©rkez√©s ideje</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- TERM√âKEK -->
  <div id="products" class="tab-content hidden">
    <h3>Term√©kt√∂rzs kezel√©se</h3>
    <div class="filters-row">
      <input id="new-item-type" placeholder="√öj term√©k neve (pl. Kab√°t)">
      <button onclick="addItem()">Term√©k l√©trehoz√°sa</button>
    </div>
    <div class="filters-row">
      <select id="item-type-select"></select>
      <input id="new-size" placeholder="√öj m√©ret (pl. XL)">
      <button onclick="addSize()">M√©ret hozz√°ad√°sa</button>
    </div>
    <div class="table-container">
      <table id="base-products-table">
        <thead>
          <tr>
            <th data-col="type">T√≠pus <button class="filter-btn" onclick="openFilter('base-products-table','type',event)">‚ñº</button></th>
            <th data-col="size">M√©ret <button class="filter-btn" onclick="openFilter('base-products-table','size',event)">‚ñº</button></th>
            <th>M≈±velet</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- DOLGOZ√ìK -->
  <div id="employees" class="tab-content hidden">
    <h3>Dolgoz√≥k kezel√©se</h3>
    <div class="filters-row">
      <input id="new-employee" placeholder="Dolgoz√≥ neve">
      <button onclick="addEmployee()">Hozz√°ad</button>
    </div>
    <div class="table-container">
      <table id="employees-table">
        <thead>
          <tr>
            <th data-col="name">N√©v <button class="filter-btn" onclick="openFilter('employees-table','name',event)">‚ñº</button></th>
            <th>M≈±velet</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MOZG√ÅSOK -->
  <div id="movements" class="tab-content hidden">
    <h3>Mozg√°sok napl√≥ja / Bizonylat</h3>
    <div class="filters-row">
      <label>D√°tum: <input type="date" id="mov-date-from" onchange="renderMovements()"></label>
      <label>-ig: <input type="date" id="mov-date-to" onchange="renderMovements()"></label>
      <button onclick="exportMovements()" class="btn-outline" style="background:white; border:1px solid #ccc; color:#333;">Excel Export</button>
      <button onclick="printSlip()" style="background:#4b5563;">üñ®Ô∏è Bizonylat nyomtat√°sa</button>
    </div>
    <div class="table-container">
      <table id="movements-table">
        <thead>
          <tr>
            <th data-col="date">D√°tum</th>
            <th data-col="employee">Dolgoz√≥ <button class="filter-btn" onclick="openFilter('movements-table','employee',event)">‚ñº</button></th>
            <th data-col="type">M≈±velet <button class="filter-btn" onclick="openFilter('movements-table','type',event)">‚ñº</button></th>
            <th data-col="item">Term√©k <button class="filter-btn" onclick="openFilter('movements-table','item',event)">‚ñº</button></th>
            <th data-col="size">M√©ret <button class="filter-btn" onclick="openFilter('movements-table','size',event)">‚ñº</button></th>
            <th data-col="qty">Menny.</th>
            <th data-col="receipt">Sz√°mla (Eredet)</th>
            <th>T√∂rl√©s</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- BACKUP -->
  <div id="backup" class="tab-content hidden">
    <h3>Biztons√°gi ment√©s (Admin)</h3>
    <p>A rendszer az adatokat a b√∂ng√©sz≈ëben t√°rolja. Rendszeresen k√©sz√≠ts ment√©st!</p>
    <button onclick="manualBackup()">Adatok ment√©se f√°jlba (.json)</button>
    <hr>
    <div id="restore-wrap" style="margin-top:10px;">
      <h4>Visszat√∂lt√©s</h4>
      <input type="file" id="restore-file" accept=".json">
      <button onclick="restoreBackup()" class="danger-btn" style="color:#b91c1c; border-color:#b91c1c;">Visszat√∂lt√©s</button>
    </div>
  </div>

</div>

<!-- NYOMTAT√ÅSI TER√úLET (REJTETT) -->
<div id="print-area"></div>

<!-- XLSX K√ñNYVT√ÅR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  // --- KONFIGUR√ÅCI√ì ---
  const USER_PASSWORD = 'schruha';
  const ADMIN_PASSWORD = 'Schedl@12345!';

  // --- ADATOK ---
  let items = [];
  let employees = [];
  let movements = [];
  let batches = []; 
  
  let currentUser = { role: 'user' };

  const lastRendered = {
    'inventory-table': [],
    'income-inventory-table': [],
    'expense-inventory-table': [],
    'base-products-table': [],
    'employees-table': [],
    'movements-table': [],
    'receipts-table': []
  };

  const tableFilters = {};

  // --- SEG√âDF√úGGV√âNYEK ---
  function sizeRank(s) {
    if (!s) return 9999;
    const map = {
      'XS': 1, 'S': 2, 'M': 3, 'L': 4, 'XL': 5,
      'XXL': 6, '2XL': 6, '3XL': 7, 'XXXL': 7, '4XL': 8, 'XXXXL': 8
    };
    if (map[s.toUpperCase()]) return map[s.toUpperCase()];
    const num = parseInt(s, 10);
    if (!isNaN(num)) return 100 + num; 
    return 5000;
  }

  // --- BEL√âP√âS ---
  function login() {
    const pw = document.getElementById('login-password').value.trim();
    const err = document.getElementById('login-error');

    if (pw === USER_PASSWORD) {
      currentUser.role = 'user';
    } else if (pw === ADMIN_PASSWORD) {
      currentUser.role = 'admin';
    } else {
      err.classList.remove('hidden');
      return;
    }

    err.classList.add('hidden');
    document.getElementById('login-screen').classList.add('hidden');
    
    // Ideiglenes parancsok elrejt√©se bel√©p√©s ut√°n (opcion√°lis, de aj√°nlott)
    document.getElementById('temp-commands').style.display = 'none';

    document.getElementById('main-app').classList.remove('hidden');

    if (currentUser.role !== 'admin') {
      document.getElementById('restore-wrap').style.display = 'none';
    }

    init();
    showTab('income');
  }

  // --- TAB KEZEL√âS ---
  function showTab(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    
    const activeTab = document.querySelector(`.tab[onclick="showTab('${id}')"]`);
    if(activeTab) activeTab.classList.add('active');
    
    document.getElementById(id).classList.remove('hidden');

    switch (id) {
      case 'income': renderInventoryTable('income-inventory-table'); updateSelects(); break;
      case 'expense': renderInventoryTable('expense-inventory-table'); updateSelects(); break;
      case 'inventory': renderInventoryTable('inventory-table'); break;
      case 'products': renderBaseProducts(); updateSelects(); break;
      case 'employees': renderEmployees(); break;
      case 'movements': renderMovements(); break;
      case 'receipts': renderReceipts(); break;
    }
  }

  function init() {
    autoLoadData();
    updateSelects();
    renderInventoryTable('inventory-table');
  }

  // --- ADATKEZEL√âS ---
  function autoSaveData() {
    recalcItemsQtyFromBatches();
    localStorage.setItem('raktarData', JSON.stringify({ items, employees, movements, batches }));
  }

  function autoLoadData() {
    const s = localStorage.getItem('raktarData');
    if (s) {
      try {
        const d = JSON.parse(s);
        items = d.items || [];
        employees = d.employees || [];
        movements = (d.movements || []).map(m => {
          if (!m.id) m.id = 'mov_' + Math.random().toString(36).slice(2);
          return m;
        });
        batches = d.batches || [];

        // MIGR√ÅCI√ì
        if ((!d.batches || d.batches.length === 0) && items.some(i => i.qty > 0)) {
           console.log("Migr√°ci√≥: Megl√©v≈ë k√©szlet konvert√°l√°sa 'Kezdeti K√©szlet' batch-ekk√©.");
           items.forEach(i => {
             if (i.qty > 0) {
               batches.push({
                 id: 'batch_init_' + Math.random().toString(36).slice(2),
                 type: i.type,
                 size: i.size,
                 receipt: 'Kezdeti K√©szlet',
                 qty: i.qty,
                 originalQty: i.qty,
                 date: new Date().toISOString()
               });
             }
           });
        }

        recalcItemsQtyFromBatches();

      } catch(e) { console.error("Hiba a bet√∂lt√©skor", e); }
    }
  }

  function recalcItemsQtyFromBatches() {
    items.forEach(i => i.qty = 0);
    batches.forEach(b => {
      const it = items.find(i => i.type === b.type && i.size === b.size);
      if (it) {
        it.qty += b.qty;
      }
    });
  }

  function updateSelects() {
    const typeSelects = [
      document.getElementById('item-type-select'),
      document.getElementById('income-type'),
      document.getElementById('expense-type')
    ];
    const types = [...new Set(items.map(i => i.type))].sort((a,b)=>a.localeCompare(b));
    
    typeSelects.forEach(sel => {
      if (!sel) return;
      const cur = sel.value;
      sel.innerHTML = '<option value="">-- V√°lassz t√≠pust --</option>';
      types.forEach(t => sel.innerHTML += `<option ${t===cur?'selected':''}>${t}</option>`);
    });

    const empSel = document.getElementById('employee-select');
    const curEmp = empSel.value;
    empSel.innerHTML = '<option value="">-- V√°lassz dolgoz√≥t --</option>';
    employees.slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(e => {
      empSel.innerHTML += `<option ${e.name===curEmp?'selected':''}>${e.name}</option>`;
    });

    const incSel = document.getElementById('income-type');
    if (incSel) incSel.onchange = () => updateSizes('income');
    const expSel = document.getElementById('expense-type');
    if (expSel) expSel.onchange = () => updateSizes('expense');
  }

  function updateSizes(section) {
    const type = document.getElementById(section + '-type').value;
    const sel = document.getElementById(section + '-size');
    const sizes = [...new Set(items.filter(i => i.type === type).map(i => i.size))];
    
    sel.innerHTML = '<option value="">-- M√©ret --</option>';
    sizes.slice().sort((a,b)=>sizeRank(a)-sizeRank(b)||a.localeCompare(b)).forEach(s => sel.innerHTML += `<option>${s}</option>`);
  }

  // --- M≈∞VELETEK ---
  function addItem() {
    const type = document.getElementById('new-item-type').value.trim();
    if (!type) { alert('Adj meg t√≠pust'); return; }
    if (items.some(i => i.type.toLowerCase() === type.toLowerCase() && !i.size)) { alert('M√°r l√©tezik'); return; }
    items.push({ type, size: '', qty: 0, minStock: 0 });
    document.getElementById('new-item-type').value = '';
    updateSelects(); renderBaseProducts(); autoSaveData();
  }

  function addSize() {
    const type = document.getElementById('item-type-select').value;
    const size = document.getElementById('new-size').value.trim();
    if (!type || !size) { alert('V√°lassz t√≠pust √©s √≠rj be m√©retet!'); return; }
    if (items.some(i => i.type === type && i.size.toLowerCase() === size.toLowerCase())) { alert('Ez a m√©ret m√°r l√©tezik ehhez a t√≠pushoz.'); return; }
    items.push({ type, size, qty: 0, minStock: 0 });
    document.getElementById('new-size').value = '';
    renderBaseProducts(); updateSelects(); autoSaveData();
  }

  function addEmployee() {
    const name = document.getElementById('new-employee').value.trim();
    if (!name) return;
    if (employees.some(e => e.name.toLowerCase() === name.toLowerCase())) { alert('M√°r l√©tezik'); return; }
    employees.push({ name });
    document.getElementById('new-employee').value = '';
    renderEmployees(); updateSelects(); autoSaveData();
  }

  function addIncome() {
    const type = document.getElementById('income-type').value;
    const size = document.getElementById('income-size').value;
    const qty = parseInt(document.getElementById('income-qty').value) || 0;
    const receipt = document.getElementById('income-receipt').value.trim();
    
    if (!type || !size || qty <= 0) { alert('T√∂lts ki minden mez≈ët (T√≠pus, M√©ret, Db)!'); return; }
    if (!receipt) { alert('K√©rlek add meg a Sz√°mla sz√°m√°t!'); return; }
    
    let ex = items.find(i => i.type === type && i.size === size);
    if (!ex) {
      items.push({ type, size, qty: 0, minStock: 0 });
      ex = items[items.length-1];
    }

    const batchId = 'batch_' + Date.now();
    batches.push({
      id: batchId,
      type: type,
      size: size,
      receipt: receipt,
      qty: qty,
      originalQty: qty,
      date: new Date().toISOString()
    });

    movements.push({
      id: 'mov_' + Date.now(),
      date: new Date().toISOString(),
      type: 'Bev√©tel',
      item: type,
      size: size,
      qty: qty,
      employee: null,
      receipt: receipt,
      batchId: batchId // Kapcsolat a batch-hez (T√∂rl√©shez kell)
    });
    
    alert('Bev√©tel r√∂gz√≠tve!');
    autoSaveData();
    renderInventoryTable('income-inventory-table');
    document.getElementById('income-qty').value = "1";
    document.getElementById('income-receipt').value = ""; 
  }

  function addExpense() {
    const type = document.getElementById('expense-type').value;
    const size = document.getElementById('expense-size').value;
    let qtyNeeded = parseInt(document.getElementById('expense-qty').value) || 0;
    const emp = document.getElementById('employee-select').value;

    if (!type || !size || !emp || qtyNeeded <= 0) { alert('T√∂lts ki minden mez≈ët!'); return; }

    const totalStock = items.find(i => i.type === type && i.size === size)?.qty || 0;
    if (totalStock < qtyNeeded) {
      alert(`Nincs el√©g k√©szlet! Jelenleg: ${totalStock} db`);
      return;
    }

    let availableBatches = batches
       .filter(b => b.type === type && b.size === size && b.qty > 0)
       .sort((a,b) => new Date(a.date) - new Date(b.date));

    let usedReceipts = []; 
    let affectedBatches = []; // Ezt mentj√ºk el a t√∂rl√©shez
    let remainingToTake = qtyNeeded;

    for (let batch of availableBatches) {
      if (remainingToTake <= 0) break;

      let takeFromBatch = Math.min(batch.qty, remainingToTake);
      
      batch.qty -= takeFromBatch;
      remainingToTake -= takeFromBatch;
      
      usedReceipts.push(`${batch.receipt} (${takeFromBatch}db)`);
      affectedBatches.push({ batchId: batch.id, qty: takeFromBatch });
    }

    movements.push({
      id: 'mov_' + Date.now(),
      date: new Date().toISOString(),
      type: 'Kiad√°s',
      item: type,
      size: size,
      qty: qtyNeeded,
      employee: emp,
      receipt: usedReceipts.join(', '),
      affectedBatches: affectedBatches // Kapcsolat a visszavon√°shoz
    });

    alert('Kiad√°s r√∂gz√≠tve!');
    autoSaveData();
    renderInventoryTable('expense-inventory-table');
    document.getElementById('expense-qty').value = "1";
  }

  // --- RENDEREL√âS ---
  function renderInventoryTable(id) {
    const tbody = document.querySelector(`#${id} tbody`);
    tbody.innerHTML = '';
    let rows = items.filter(i => i.size); 

    rows = applyDataFilters(id, rows, { 'type': r => r.type, 'size': r => r.size });
    lastRendered[id] = rows;

    if (!rows.length) { tbody.innerHTML = '<tr><td colspan="4">Nincs adat</td></tr>'; return; }

    rows.sort((a,b)=>a.type.localeCompare(b.type) || sizeRank(a.size)-sizeRank(b.size))
        .forEach(r => {
          const tr = document.createElement('tr');
          if (r.minStock && r.qty < r.minStock) tr.classList.add('low-stock');
          tr.innerHTML = `
            <td>${r.type}</td>
            <td>${r.size}</td>
            <td><strong>${r.qty}</strong></td>
            <td><input type="number" value="${r.minStock||0}" style="width:50px" onchange="updateMinStock('${r.type}','${r.size}',this.value)"></td>
          `;
          tbody.appendChild(tr);
        });
  }

  function renderReceipts() {
    const tbody = document.querySelector('#receipts-table tbody');
    tbody.innerHTML = '';
    let rows = batches.filter(b => b.qty > 0);
    
    rows = applyDataFilters('receipts-table', rows, {
      'receipt': r => r.receipt,
      'type': r => r.type,
      'size': r => r.size
    });
    
    lastRendered['receipts-table'] = rows;

    if(!rows.length) { tbody.innerHTML = '<tr><td colspan="5">Nincs rakt√°ron l√©v≈ë t√©tel.</td></tr>'; return; }

    rows.sort((a,b) => a.type.localeCompare(b.type) || sizeRank(a.size)-sizeRank(b.size) || new Date(a.date)-new Date(b.date));

    rows.forEach(r => {
      const dateStr = new Date(r.date).toLocaleDateString();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.receipt}</td>
        <td>${r.type}</td>
        <td>${r.size}</td>
        <td><strong>${r.qty}</strong> / ${r.originalQty}</td>
        <td>${dateStr}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderBaseProducts() {
    const tbody = document.querySelector('#base-products-table tbody');
    tbody.innerHTML = '';
    let rows = items.slice();
    rows = applyDataFilters('base-products-table', rows, { 'type': r => r.type, 'size': r => r.size || '-' });
    lastRendered['base-products-table'] = rows;

    if(!rows.length) { tbody.innerHTML = '<tr><td colspan="3">√úres</td></tr>'; return; }

    rows.sort((a,b)=>a.type.localeCompare(b.type) || (a.size||'').localeCompare(b.size||''))
        .forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.type}</td><td>${r.size||'-'}</td>
            <td><button class="danger-btn" onclick="deleteItem('${r.type}','${r.size||''}')">T√∂rl√©s</button></td>`;
          tbody.appendChild(tr);
        });
  }

  function renderEmployees() {
    const tbody = document.querySelector('#employees-table tbody');
    tbody.innerHTML = '';
    let rows = employees.slice();
    rows = applyDataFilters('employees-table', rows, { 'name': r => r.name });
    lastRendered['employees-table'] = rows;

    if(!rows.length) { tbody.innerHTML = '<tr><td colspan="2">√úres</td></tr>'; return; }

    rows.sort((a,b)=>a.name.localeCompare(b.name)).forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.name}</td><td><button class="danger-btn" onclick="deleteEmployee('${e.name}')">T√∂rl√©s</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function renderMovements() {
    const tbody = document.querySelector('#movements-table tbody');
    tbody.innerHTML = '';
    const from = document.getElementById('mov-date-from').value;
    const to = document.getElementById('mov-date-to').value;

    let rows = movements.slice();
    if (from) rows = rows.filter(m => new Date(m.date) >= new Date(from));
    if (to) rows = rows.filter(m => new Date(m.date) <= new Date(to + 'T23:59:59'));

    rows = applyDataFilters('movements-table', rows, {
      'employee': r => r.employee || '-',
      'type': r => r.type,
      'item': r => r.item,
      'size': r => r.size || ''
    });

    rows.sort((a,b)=>new Date(b.date)-new Date(a.date));
    lastRendered['movements-table'] = rows;

    if (!rows.length) { tbody.innerHTML = '<tr><td colspan="8">Nincs mozg√°s</td></tr>'; return; }

    rows.forEach(m => {
      const d = new Date(m.date);
      const ds = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const tr = document.createElement('tr');
      
      // T√∂r√∂lhet≈ës√©g ellen≈ërz√©se
      let canDelete = false;
      if (m.type === 'Bev√©tel' && m.batchId) {
          // Csak akkor t√∂r√∂lhet≈ë, ha m√©g √©rintetlen (nem volt bel≈ële kiad√°s)
          const b = batches.find(b => b.id === m.batchId);
          if (b && b.qty === b.originalQty) canDelete = true;
      } else if (m.type === 'Kiad√°s' && m.affectedBatches && m.affectedBatches.length > 0) {
          // Kiad√°s t√∂r√∂lhet≈ë, ha megvannak az adatok a visszat√∂lt√©shez
          canDelete = true;
      }

      const delBtn = canDelete 
        ? `<button class="danger-btn" onclick="deleteMovement('${m.id}')">X</button>`
        : `<button class="disabled-btn" title="R√©gi adat vagy m√°r felhaszn√°lt k√©szlet">X</button>`;

      tr.innerHTML = `
        <td>${ds}</td>
        <td>${m.employee || '-'}</td>
        <td>${m.type}</td>
        <td>${m.item}</td>
        <td>${m.size || ''}</td>
        <td>${m.qty}</td>
        <td style="font-size:12px; color:#555;">${m.receipt || '-'}</td>
        <td>${delBtn}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- T√ñRL√âSEK ---
  function deleteItem(t, s) { if(confirm('T√∂rl√∂d?')) { items=items.filter(i=>!(i.type===t && (i.size||'')===(s||''))); renderBaseProducts(); autoSaveData(); } }
  function deleteEmployee(n) { if(confirm('T√∂rl√∂d?')) { employees=employees.filter(e=>e.name!==n); renderEmployees(); autoSaveData(); } }
  
  function deleteMovement(id) {
      const mIdx = movements.findIndex(m => m.id === id);
      if (mIdx === -1) return;
      const m = movements[mIdx];

      if (!confirm('Biztosan t√∂rl√∂d/visszavonod ezt a mozg√°st?')) return;

      if (m.type === 'Bev√©tel') {
          // Ellen≈ërizz√ºk m√©gegyszer, hogy nem fogyott-e bel≈ële
          const bIdx = batches.findIndex(b => b.id === m.batchId);
          if (bIdx > -1) {
              if (batches[bIdx].qty !== batches[bIdx].originalQty) {
                  alert('HIBA: Ebb≈ël a bev√©telb≈ël m√°r t√∂rt√©nt kiad√°s, nem t√∂r√∂lhet≈ë!');
                  return;
              }
              // T√∂r√∂lj√ºk a batch-et
              batches.splice(bIdx, 1);
          }
      } else if (m.type === 'Kiad√°s') {
          // Visszat√∂ltj√ºk a k√©szletet a megfelel≈ë batch-ekbe
          if (m.affectedBatches) {
              m.affectedBatches.forEach(aff => {
                  const b = batches.find(b => b.id === aff.batchId);
                  if (b) {
                      b.qty += aff.qty;
                  } else {
                      console.warn('Nem tal√°lhat√≥ batch visszat√∂lt√©shez:', aff.batchId);
                  }
              });
          }
      }

      // Mozg√°s t√∂rl√©se
      movements.splice(mIdx, 1);
      
      alert('Mozg√°s t√∂r√∂lve/visszavonva.');
      autoSaveData(); // √öjrasz√°molja az √∂sszes√≠tett item qty-t
      renderMovements();
      // Friss√≠teni kell a k√©szlet t√°bl√°zatokat is, mert v√°ltozhatott
      renderInventoryTable('income-inventory-table');
      renderInventoryTable('expense-inventory-table');
      renderInventoryTable('inventory-table');
  }

  function updateMinStock(t, s, v) { const i=items.find(x=>x.type===t && x.size===s); if(i){ i.minStock=Number(v); autoSaveData(); } }

  // --- EXPORT & PRINT ---
  function exportInventory() {
    const rows = lastRendered['inventory-table'];
    if(!rows.length) return alert('Nincs adat');
    const ws = XLSX.utils.json_to_sheet(rows.map(r=>({ 'T√≠pus':r.type, 'M√©ret':r.size, 'K√©szlet':r.qty })));
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "K√©szlet");
    XLSX.writeFile(wb, "Keszlet.xlsx");
  }

  function exportMovements() {
    const rows = lastRendered['movements-table'];
    if(!rows.length) return alert('Nincs adat');
    const ws = XLSX.utils.json_to_sheet(rows.map(m=>({
      'D√°tum': new Date(m.date).toLocaleString(),
      'Dolgoz√≥': m.employee||'', 'T√≠pus': m.type, 'Term√©k': m.item, 'M√©ret': m.size, 'Db': m.qty, 'Sz√°mla': m.receipt || ''
    })));
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Mozgasok");
    XLSX.writeFile(wb, "Mozgasok.xlsx");
  }

  function manualBackup() {
    const blob = new Blob([JSON.stringify({items,employees,movements,batches})], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
  }

  function restoreBackup() {
    const f = document.getElementById('restore-file').files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
      try {
        const d = JSON.parse(e.target.result);
        
        // 1. Adatok bet√∂lt√©se
        items = d.items || [];
        employees = d.employees || [];
        movements = d.movements || [];
        batches = d.batches || [];

        // 2. Migr√°ci√≥
        if ((!d.batches || d.batches.length === 0) && items.some(i => i.qty > 0)) {
           items.forEach(i => {
             if (i.qty > 0) {
               batches.push({
                 id: 'batch_restored_' + Math.random().toString(36).slice(2),
                 type: i.type,
                 size: i.size,
                 receipt: 'Visszat√∂lt√∂tt (Ismeretlen)',
                 qty: i.qty,
                 originalQty: i.qty,
                 date: new Date().toISOString()
               });
             }
           });
        }

        // 3. Ment√©s √âS Friss√≠t√©s
        autoSaveData(); 
        alert('Sikeres visszat√∂lt√©s! Az oldal √∫jrat√∂lt≈ëdik.');
        location.reload(); 
        
      } catch(err){ 
        console.error(err);
        alert('Hiba a f√°jl feldolgoz√°sakor!'); 
      }
    };
    r.readAsText(f);
  }

  // --- BIZONYLAT NYOMTAT√ÅS ---
  function printSlip() {
    const rows = lastRendered['movements-table'] || [];
    if (rows.length === 0) {
      alert('Nincs mit nyomtatni! A lista √ºres.');
      return;
    }

    const employeesInList = [...new Set(rows.map(r => r.employee).filter(Boolean))];
    const employeeName = employeesInList.length === 1 ? employeesInList[0] : (employeesInList.length > 1 ? 'Vegyes lista' : '-');
    const today = new Date().toLocaleDateString();

    const printDiv = document.getElementById('print-area');
    
    let rowsHtml = '';
    rows.forEach(r => {
       const dateStr = new Date(r.date).toLocaleDateString();
       rowsHtml += `
         <tr>
           <td>${dateStr}</td>
           <td>${r.item}</td>
           <td>${r.size || '-'}</td>
           <td>${r.qty} db</td>
           <td>${r.type}</td>
         </tr>
       `;
    });

    printDiv.innerHTML = `
      <div class="print-header">
        <h1>Kiad√°si Bizonylat</h1>
        <p>Schedl Munkaruha Debrecen</p>
      </div>

      <div class="print-meta">
        <div><strong>Dolgoz√≥:</strong> ${employeeName}</div>
        <div><strong>D√°tum:</strong> ${today}</div>
      </div>

      <table class="print-table">
        <thead>
          <tr>
            <th>D√°tum</th>
            <th>Term√©k</th>
            <th>M√©ret</th>
            <th>Mennyis√©g</th>
            <th>M≈±velet</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>

      <div class="print-footer">
        <div class="signature-box">
          <div class="signature-line">Kiadta (Rakt√°r)</div>
        </div>
        <div class="signature-box">
          <div class="signature-line">√Åtvette (Dolgoz√≥)</div>
        </div>
      </div>
    `;

    window.print();
  }


  // --- FEJLETT SZ≈∞R≈ê ---
  function openFilter(tableId, colKey, ev) {
    ev.stopPropagation();
    closeAllFilters();

    const th = ev.target.closest('th');
    const dropdown = document.createElement('div');
    dropdown.className = 'filter-dropdown';
    
    const rows = lastRendered[tableId] || [];
    let vals = [];

    // √ârt√©kek kinyer√©se
    if(tableId.includes('inventory') || tableId==='base-products-table'){
        if(colKey==='type') vals = [...new Set(rows.map(r=>r.type))];
        if(colKey==='size') vals = [...new Set(rows.map(r=>r.size))];
    }
    if(tableId==='receipts-table') {
        if(colKey==='receipt') vals = [...new Set(rows.map(r=>r.receipt))];
        if(colKey==='type') vals = [...new Set(rows.map(r=>r.type))];
        if(colKey==='size') vals = [...new Set(rows.map(r=>r.size))];
    }
    if(tableId==='employees-table' && colKey==='name') vals = [...new Set(rows.map(r=>r.name))];
    if(tableId==='movements-table') {
        if(colKey==='employee') vals = [...new Set(rows.map(r=>r.employee||'-'))];
        if(colKey==='type') vals = [...new Set(rows.map(r=>r.type))];
        if(colKey==='item') vals = [...new Set(rows.map(r=>r.item))];
        if(colKey==='size') vals = [...new Set(rows.map(r=>r.size||''))];
    }
    
    // Rendez√©s
    vals.sort((a,b)=>{
       if(!a) return 1; if(!b) return -1;
       return sizeRank(a)-sizeRank(b) || a.toString().localeCompare(b.toString());
    });

    const active = (tableFilters[tableId] && tableFilters[tableId][colKey]) ? new Set(tableFilters[tableId][colKey]) : null;

    // Checkboxok
    vals.forEach(v => {
      const lbl = document.createElement('label');
      lbl.onclick = e => e.stopPropagation();
      const chk = !active || active.has(v);
      lbl.innerHTML = `<input type="checkbox" value="${v}" ${chk?'checked':''}> ${v||'(√ºres)'}`;
      dropdown.appendChild(lbl);
    });

    // Gombok
    const act = document.createElement('div');
    act.className = 'filter-actions';
    
    const btnNone = document.createElement('button');
    btnNone.className = 'btn-secondary';
    btnNone.innerHTML = '‚òê Mind t√∂r√∂l';
    btnNone.onclick = (e) => {
        e.stopPropagation();
        dropdown.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
    };

    const btnOk = document.createElement('button');
    btnOk.textContent = 'OK';
    btnOk.onclick = e => {
      e.stopPropagation();
      const chosen = [];
      dropdown.querySelectorAll('input:checked').forEach(c=>chosen.push(c.value));
      if(!tableFilters[tableId]) tableFilters[tableId]={};
      tableFilters[tableId][colKey] = chosen;
      refreshTableById(tableId);
      dropdown.remove();
    };

    const btnClr = document.createElement('button');
    btnClr.className = 'btn-outline';
    btnClr.textContent = 'Sz≈±r≈ë ki';
    btnClr.onclick = e => {
      e.stopPropagation();
      if(tableFilters[tableId]) delete tableFilters[tableId][colKey];
      refreshTableById(tableId);
      dropdown.remove();
    };

    act.appendChild(btnNone);
    act.appendChild(btnClr);
    act.appendChild(btnOk);
    dropdown.appendChild(act);
    th.appendChild(dropdown);
  }

  function closeAllFilters() { document.querySelectorAll('.filter-dropdown').forEach(d=>d.remove()); }
  document.addEventListener('click', e => {
    if(!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-btn')) closeAllFilters();
  });

  function refreshTableById(tid) {
    if(tid.includes('inventory')) renderInventoryTable(tid);
    if(tid==='base-products-table') renderBaseProducts();
    if(tid==='employees-table') renderEmployees();
    if(tid==='movements-table') renderMovements();
    if(tid==='receipts-table') renderReceipts();
  }

  function applyDataFilters(tid, rows, mapFns) {
    const tf = tableFilters[tid];
    if(!tf) return rows;
    return rows.filter(r => {
      for(const col in tf) {
        const sel = tf[col];
        if(sel && sel.length) {
          const val = mapFns[col] ? mapFns[col](r) : '';
          if(!sel.includes(val)) return false;
        }
      }
      return true;
    });
  }

</script>
</body>
</html>
