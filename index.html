<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schedl Munkaruha Debrecen</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --panel: #ffffff;
      --primary: #0f5fa8;
      --border: #e5e7eb;
      --text: #1f2937;
      --muted: #6b7280;
      --danger: #b91c1c;
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      text-align: center;
      font-weight: 600;
      color: var(--primary);
    }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #08467c; }
    input, select {
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
    }
    .hidden { display: none !important; }

    /* login */
    #login-screen {
      max-width: 380px;
      margin: 60px auto;
      background: var(--panel);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    #login-screen h2 {
      margin-top: 0;
      color: var(--primary);
    }
    #login-error { color: var(--danger); margin-top: 8px; }

    /* tabs */
    .tabs {
      display: flex;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      gap: 4px;
      padding: 0 10px;
    }
    .tab {
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: #eef4fb;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
    }

    /* panels */
    .tab-content {
      background: var(--panel);
      margin: 16px;
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13.5px;
      margin-top: 10px;
      position: relative;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 6px 4px;
      text-align: center;
    }
    th {
      background: #f8fafc;
      font-weight: 600;
      position: relative;
    }
    tr.low-stock {
      background: #ffe4e6;
    }
    .danger-btn {
      background: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }
    .danger-btn:hover {
      background: #fecaca;
    }
    .filters-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    /* header filter dropdown */
    .filter-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 11px;
      color: #4b5563;
      position: absolute;
      right: 4px;
      top: 3px;
      padding: 2px 5px;
      border-radius: 4px;
    }
    .filter-btn:hover {
      background: rgba(15,95,168,0.1);
    }
    .filter-dropdown {
      position: absolute;
      top: 26px;
      right: 2px;
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.08);
      padding: 6px;
      z-index: 999;
      max-height: 180px;
      overflow-y: auto;
      min-width: 160px;
    }
    .filter-dropdown label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin: 2px 0;
      cursor: pointer;
    }
    .filter-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>

<header>Schedl Munkaruha Debrecen</header>

<!-- BELÉPÉS -->
<div id="login-screen">
  <h2>Belépés</h2>
  <label for="login-password">Jelszó</label><br>
  <input id="login-password" type="password" placeholder="••••••••" onkeypress="if(event.key==='Enter') login()">
  <br><br>
  <button onclick="login()">Belépés</button>
  <p id="login-error" style="display:none;">Hibás jelszó!</p>
</div>

<!-- APP -->
<div id="main-app" class="hidden">

  <div class="tabs">
    <div class="tab active" onclick="showTab('income')">Bevétel</div>
    <div class="tab" onclick="showTab('expense')">Kiadás</div>
    <div class="tab" onclick="showTab('inventory')">Készlet</div>
    <div class="tab" onclick="showTab('products')">Termékek</div>
    <div class="tab" onclick="showTab('employees')">Dolgozók</div>
    <div class="tab" onclick="showTab('movements')">Mozgások</div>
    <div class="tab" id="backup-tab" onclick="showTab('backup')">Backup</div>
  </div>

  <!-- BEVÉTEL -->
  <div id="income" class="tab-content">
    <h3>Bevétel rögzítése</h3>
    <div class="filters-row">
      <select id="income-type"></select>
      <select id="income-size"></select>
      <input id="income-qty" type="number" min="1" value="1" style="width:80px;">
      <button onclick="addIncome()">Mentés</button>
    </div>
    <h4>Aktuális készlet</h4>
    <table id="income-inventory-table">
      <thead>
        <tr>
          <th data-col="type">Típus <button class="filter-btn" onclick="openFilter('income-inventory-table','type',event)">▼</button></th>
          <th data-col="size">Méret <button class="filter-btn" onclick="openFilter('income-inventory-table','size',event)">▼</button></th>
          <th data-col="qty">Darab</th>
          <th data-col="min">Minimum</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- KIADÁS -->
  <div id="expense" class="tab-content hidden">
    <h3>Kiadás rögzítése</h3>
    <div class="filters-row">
      <select id="employee-select"></select>
      <select id="expense-type"></select>
      <select id="expense-size"></select>
      <input id="expense-qty" type="number" min="1" value="1" style="width:80px;">
      <button onclick="addExpense()">Mentés</button>
    </div>
    <h4>Aktuális készlet</h4>
    <table id="expense-inventory-table">
      <thead>
        <tr>
          <th data-col="type">Típus <button class="filter-btn" onclick="openFilter('expense-inventory-table','type',event)">▼</button></th>
          <th data-col="size">Méret <button class="filter-btn" onclick="openFilter('expense-inventory-table','size',event)">▼</button></th>
          <th data-col="qty">Darab</th>
          <th data-col="min">Minimum</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- KÉSZLET -->
  <div id="inventory" class="tab-content hidden">
    <h3>Készlet</h3>
    <button onclick="exportInventory()">Exportálás Excelbe</button>
    <table id="inventory-table">
      <thead>
        <tr>
          <th data-col="type">Típus <button class="filter-btn" onclick="openFilter('inventory-table','type',event)">▼</button></th>
          <th data-col="size">Méret <button class="filter-btn" onclick="openFilter('inventory-table','size',event)">▼</button></th>
          <th data-col="qty">Darab</th>
          <th data-col="min">Minimum</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- TERMÉKEK -->
  <div id="products" class="tab-content hidden">
    <h3>Termékek</h3>
    <div class="filters-row">
      <input id="new-item-type" placeholder="Új terméktípus">
      <button onclick="addItem()">Hozzáad</button>
    </div>
    <div class="filters-row">
      <select id="item-type-select"></select>
      <input id="new-size" placeholder="Új méret">
      <button onclick="addSize()">Hozzáad</button>
    </div>
    <table id="base-products-table">
      <thead>
        <tr>
          <th data-col="type">Típus <button class="filter-btn" onclick="openFilter('base-products-table','type',event)">▼</button></th>
          <th data-col="size">Méret <button class="filter-btn" onclick="openFilter('base-products-table','size',event)">▼</button></th>
          <th>Művelet</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- DOLGOZÓK -->
  <div id="employees" class="tab-content hidden">
    <h3>Dolgozók</h3>
    <div class="filters-row">
      <input id="new-employee" placeholder="Név">
      <button onclick="addEmployee()">Hozzáad</button>
    </div>
    <table id="employees-table">
      <thead>
        <tr>
          <th data-col="name">Név <button class="filter-btn" onclick="openFilter('employees-table','name',event)">▼</button></th>
          <th>Művelet</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- MOZGÁSOK -->
  <div id="movements" class="tab-content hidden">
    <h3>Mozgások</h3>
    <div class="filters-row">
      <label>Dátum tól: <input type="date" id="mov-date-from" onchange="renderMovements()"></label>
      <label>ig: <input type="date" id="mov-date-to" onchange="renderMovements()"></label>
      <button onclick="exportMovements()">Exportálás</button>
    </div>
    <table id="movements-table">
      <thead>
        <tr>
          <th data-col="date">Dátum</th>
          <th data-col="employee">Dolgozó <button class="filter-btn" onclick="openFilter('movements-table','employee',event)">▼</button></th>
          <th data-col="type">Művelet <button class="filter-btn" onclick="openFilter('movements-table','type',event)">▼</button></th>
          <th data-col="size">Méret <button class="filter-btn" onclick="openFilter('movements-table','size',event)">▼</button></th>
          <th data-col="qty">Mennyiség</th>
          <th>Művelet</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- BACKUP -->
  <div id="backup" class="tab-content hidden">
    <h3>Adatmentés / visszatöltés</h3>
    <button onclick="manualBackup()">Mentés (JSON)</button>
    <div id="restore-wrap" style="margin-top:10px;">
      <input type="file" id="restore-file" accept=".json">
      <button onclick="restoreBackup()">Visszatöltés</button>
    </div>
  </div>

</div>

<!-- XLSX -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  // jelszavak
  const USER_PASSWORD = 'schruha';
  const ADMIN_PASSWORD = 'Schedl@12345!';

  let items = [];
  let employees = [];
  let movements = [];
  let currentUser = { role: 'user' };

  // ide tesszük a legutóbb kirajzolt adatokat -> ebből építjük a szűrőt és ebből exportálunk
  const lastRendered = {
    'inventory-table': [],
    'income-inventory-table': [],
    'expense-inventory-table': [],
    'base-products-table': [],
    'employees-table': [],
    'movements-table': []
  };

  // aktív szűrők
  const tableFilters = {};

  // méret sorrend
  function sizeRank(s) {
    if (!s) return 9999;
    const map = {
      'XS': 1,
      'S': 2,
      'M': 3,
      'L': 4,
      'XL': 5,
      'XXL': 6, '2XL': 6,
      'XXXL': 7, '3XL': 7,
      'XXXXL': 8, '4XL': 8
    };
    if (map[s]) return map[s];
    const num = parseInt(s, 10);
    if (!isNaN(num)) return 100 + num; // cipőméret
    return 5000;
  }

  // belépés
  function login() {
    const pw = document.getElementById('login-password').value.trim();
    const err = document.getElementById('login-error');

    if (pw === USER_PASSWORD) {
      currentUser.role = 'user';
    } else if (pw === ADMIN_PASSWORD) {
      currentUser.role = 'admin';
    } else {
      err.style.display = 'block';
      return;
    }

    err.style.display = 'none';
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');

    // backup jog
    const restoreBlock = document.getElementById('restore-wrap');
    if (currentUser.role !== 'admin') {
      restoreBlock.style.display = 'none';
    } else {
      restoreBlock.style.display = 'block';
    }

    init();
    showTab('income');
  }

  // tab váltás
  function showTab(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelector('.tab[onclick="showTab(\''+id+'\')"]').classList.add('active');
    document.getElementById(id).classList.remove('hidden');

    switch (id) {
      case 'income': renderInventoryTable('income-inventory-table'); updateSelects(); break;
      case 'expense': renderInventoryTable('expense-inventory-table'); updateSelects(); break;
      case 'inventory': renderInventoryTable('inventory-table'); break;
      case 'products': renderBaseProducts(); updateSelects(); break;
      case 'employees': renderEmployees(); break;
      case 'movements': renderMovements(); break;
    }
  }

  function init() {
    autoLoadData();
    updateSelects();
    renderInventoryTable('inventory-table');
    renderInventoryTable('income-inventory-table');
    renderInventoryTable('expense-inventory-table');
    renderBaseProducts();
    renderEmployees();
    renderMovements();
  }

  function autoSaveData() {
    localStorage.setItem('raktarData', JSON.stringify({ items, employees, movements }));
  }
  function autoLoadData() {
    const s = localStorage.getItem('raktarData');
    if (s) {
      try {
        const d = JSON.parse(s);
        items = d.items || [];
        employees = d.employees || [];
        movements = (d.movements || []).map(m => {
          if (!m.id) m.id = 'mov_' + Math.random().toString(36).slice(2);
          return m;
        });
      } catch(e) {}
    }
  }

  // selectek
  function updateSelects() {
    const typeSelects = [
      document.getElementById('item-type-select'),
      document.getElementById('income-type'),
      document.getElementById('expense-type')
    ];
    const types = [...new Set(items.map(i => i.type))].sort((a,b)=>a.localeCompare(b));
    typeSelects.forEach(sel => {
      if (!sel) return;
      sel.innerHTML = '<option value="">-- termék --</option>';
      types.forEach(t => sel.innerHTML += `<option>${t}</option>`);
    });

    const empSel = document.getElementById('employee-select');
    empSel.innerHTML = '<option value="">-- dolgozó --</option>';
    employees.slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(e => {
      empSel.innerHTML += `<option>${e.name}</option>`;
    });

    const incSel = document.getElementById('income-type');
    if (incSel) incSel.onchange = () => updateSizes('income');
    const expSel = document.getElementById('expense-type');
    if (expSel) expSel.onchange = () => updateSizes('expense');
  }

  function updateSizes(section) {
    const type = document.getElementById(section + '-type').value;
    const sel = document.getElementById(section + '-size');
    const sizes = [...new Set(items.filter(i => i.type === type).map(i => i.size))];
    sel.innerHTML = '<option value="">-- méret --</option>';
    sizes.slice().sort((a,b)=>sizeRank(a)-sizeRank(b)||a.localeCompare(b)).forEach(s => sel.innerHTML += `<option>${s}</option>`);
  }

  // termék
  function addItem() {
    const type = document.getElementById('new-item-type').value.trim();
    if (!type) { alert('Adj meg típust'); return; }
    if (items.some(i => i.type.toLowerCase() === type.toLowerCase() && !i.size)) {
      alert('Ez a típus már létezik.');
      return;
    }
    items.push({ type, size: '', qty: 0, minStock: 0 });
    document.getElementById('new-item-type').value = '';
    updateSelects();
    renderBaseProducts();
    autoSaveData();
  }

  // méret
  function addSize() {
    const type = document.getElementById('item-type-select').value;
    const size = document.getElementById('new-size').value.trim();
    if (!type || !size) { alert('Válassz terméket és méretet.'); return; }
    if (items.some(i => i.type.toLowerCase() === type.toLowerCase() && i.size.toLowerCase() === size.toLowerCase())) {
      alert('Már van ilyen méret.');
      return;
    }
    items.push({ type, size, qty: 0, minStock: 0 });
    document.getElementById('new-size').value = '';
    renderBaseProducts();
    updateSelects();
    autoSaveData();
  }

  // dolgozó
  function addEmployee() {
    const name = document.getElementById('new-employee').value.trim();
    if (!name) { alert('Adj meg nevet.'); return; }
    if (employees.some(e => e.name.toLowerCase() === name.toLowerCase())) {
      alert('Már van ilyen dolgozó.');
      return;
    }
    employees.push({ name });
    document.getElementById('new-employee').value = '';
    renderEmployees();
    updateSelects();
    autoSaveData();
  }

  // bevétel
  function addIncome() {
    const type = document.getElementById('income-type').value;
    const size = document.getElementById('income-size').value;
    const qty = parseInt(document.getElementById('income-qty').value) || 0;
    if (!type || !size || qty <= 0) { alert('Tölts ki mindent.'); return; }

    const ex = items.find(i => i.type === type && i.size === size);
    if (ex) ex.qty += qty;
    else items.push({ type, size, qty, minStock: 0 });

    movements.push({
      id: 'mov_' + Math.random().toString(36).slice(2),
      date: new Date().toISOString(),
      type: 'Bevétel',
      item: type,
      size: size,
      qty: qty,
      employee: null
    });

    renderAll();
    autoSaveData();
  }

  // kiadás
  function addExpense() {
    const type = document.getElementById('expense-type').value;
    const size = document.getElementById('expense-size').value;
    const qty = parseInt(document.getElementById('expense-qty').value) || 0;
    const emp = document.getElementById('employee-select').value;
    if (!type || !size || !emp || qty <= 0) { alert('Tölts ki mindent.'); return; }

    const ex = items.find(i => i.type === type && i.size === size);
    if (!ex || ex.qty < qty) {
      alert('Nincs elég készlet.');
      return;
    }
    ex.qty -= qty;

    movements.push({
      id: 'mov_' + Math.random().toString(36).slice(2),
      date: new Date().toISOString(),
      type: 'Kiadás',
      item: type,
      size: size,
      qty: qty,
      employee: emp
    });

    renderAll();
    autoSaveData();
  }

  function renderAll() {
    renderInventoryTable('income-inventory-table');
    renderInventoryTable('expense-inventory-table');
    renderInventoryTable('inventory-table');
    renderBaseProducts();
    renderEmployees();
    renderMovements();
  }

  // készlet táblák
  function renderInventoryTable(id) {
    const tbody = document.querySelector(`#${id} tbody`);
    tbody.innerHTML = '';
    let rows = items.filter(i => i.size); // csak aminek van mérete

    rows = applyDataFilters(id, rows, {
      'type': r => r.type,
      'size': r => r.size
    });

    lastRendered[id] = rows;

    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="4">Nincs adat</td></tr>';
      return;
    }

    rows
      .slice()
      .sort((a,b)=>a.type.localeCompare(b.type) || sizeRank(a.size)-sizeRank(b.size))
      .forEach(r => {
        const tr = document.createElement('tr');
        if (r.minStock && r.qty < r.minStock) tr.classList.add('low-stock');
        tr.innerHTML = `
          <td>${r.type}</td>
          <td>${r.size}</td>
          <td>${r.qty}</td>
          <td><input type="number" value="${r.minStock || 0}" style="width:60px" onchange="updateMinStock('${r.type}','${r.size}',this.value)"></td>
        `;
        tbody.appendChild(tr);
      });
  }

  // termékek tábla
  function renderBaseProducts() {
    const tbody = document.querySelector('#base-products-table tbody');
    tbody.innerHTML = '';
    let rows = items.slice();

    rows = applyDataFilters('base-products-table', rows, {
      'type': r => r.type,
      'size': r => r.size || '-'
    });

    lastRendered['base-products-table'] = rows;

    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="3">Nincs adat</td></tr>';
      return;
    }

    rows
      .sort((a,b)=>a.type.localeCompare(b.type) || (a.size||'').localeCompare(b.size||''))
      .forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.type}</td>
          <td>${r.size || '-'}</td>
          <td><button class="danger-btn" onclick="deleteItem('${r.type}','${r.size||''}')">Törlés</button></td>
        `;
        tbody.appendChild(tr);
      });
  }

  // dolgozók
  function renderEmployees() {
    const tbody = document.querySelector('#employees-table tbody');
    tbody.innerHTML = '';
    let rows = employees.slice();

    rows = applyDataFilters('employees-table', rows, {
      'name': r => r.name
    });

    lastRendered['employees-table'] = rows;

    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="2">Nincs adat</td></tr>';
      return;
    }

    rows
      .sort((a,b)=>a.name.localeCompare(b.name))
      .forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.name}</td>
          <td><button class="danger-btn" onclick="deleteEmployee('${e.name}')">Törlés</button></td>
        `;
        tbody.appendChild(tr);
      });
  }

  // mozgások
  function renderMovements() {
    const tbody = document.querySelector('#movements-table tbody');
    tbody.innerHTML = '';

    const from = document.getElementById('mov-date-from').value;
    const to = document.getElementById('mov-date-to').value;

    let rows = movements.slice();

    // dátum szűrő
    rows = rows.filter(m => {
      const d = new Date(m.date);
      if (from && d < new Date(from)) return false;
      if (to && d > new Date(to + 'T23:59:59')) return false;
      return true;
    });

    // adat alapú szűrők
    rows = applyDataFilters('movements-table', rows, {
      'employee': r => r.employee || '-',
      'type': r => r.type,
      'size': r => r.size || ''
    });

    rows.sort((a,b)=>new Date(b.date)-new Date(a.date) || sizeRank(a.size)-sizeRank(b.size));

    lastRendered['movements-table'] = rows;

    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="6">Nincs mozgás</td></tr>';
      return;
    }

    rows.forEach(m => {
      const d = new Date(m.date);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.toLocaleString()}</td>
        <td>${m.employee || '-'}</td>
        <td>${m.type}</td>
        <td>${m.size || ''}</td>
        <td>${m.qty}</td>
        <td><button class="danger-btn" onclick="deleteMovement('${m.id}')">Törlés</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // törlések
  function deleteItem(type, size) {
    if (!confirm('Biztosan törlöd ezt a terméket/méretet?')) return;
    items = items.filter(i => !(i.type === type && (i.size || '') === (size || '')));
    renderAll();
    updateSelects();
    autoSaveData();
  }
  function deleteEmployee(name) {
    if (!confirm('Biztosan törlöd ezt a dolgozót?')) return;
    employees = employees.filter(e => e.name !== name);
    renderEmployees();
    updateSelects();
    autoSaveData();
  }
  function deleteMovement(id) {
    if (!confirm('Biztosan törlöd ezt a mozgást?')) return;
    movements = movements.filter(m => m.id !== id);
    renderMovements();
    autoSaveData();
  }

  // min készlet
  function updateMinStock(type, size, val) {
    const ex = items.find(i => i.type === type && i.size === size);
    if (ex) {
      ex.minStock = Number(val) || 0;
      autoSaveData();
      renderAll();
    }
  }

  // EXPORT
  function exportInventory() {
    const rows = lastRendered['inventory-table'] || [];
    if (!rows.length) { alert('Nincs exportálható adat.'); return; }

    const exp = rows
      .filter(r => r.size) // kérted: csak aminek van méret
      .map(r => ({
        'Típus': r.type,
        'Méret': r.size,
        'Darab': r.qty,
        'Minimum': r.minStock || 0
      }));

    if (!exp.length) { alert('A szűrés miatt nincs olyan sor, aminek van mérete.'); return; }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exp);
    XLSX.utils.book_append_sheet(wb, ws, "Készlet");
    XLSX.writeFile(wb, "készlet.xlsx");
  }

  function exportMovements() {
    const rows = lastRendered['movements-table'] || [];
    if (!rows.length) { alert('Nincs exportálható mozgás.'); return; }

    const exp = rows.map(m => ({
      'Dátum': new Date(m.date).toLocaleString(),
      'Dolgozó': m.employee || '-',
      'Művelet': m.type,
      'Méret': m.size || '',
      'Mennyiség': m.qty
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exp);
    XLSX.utils.book_append_sheet(wb, ws, "Mozgások");
    XLSX.writeFile(wb, "mozgások.xlsx");
  }

  // BACKUP
  function manualBackup() {
    const blob = new Blob([JSON.stringify({ items, employees, movements }, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function restoreBackup() {
    const fileInput = document.getElementById('restore-file');
    if (fileInput.files.length === 0) { alert('Válassz egy fájlt!'); return; }
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        items = data.items || [];
        employees = data.employees || [];
        movements = (data.movements || []).map(m => {
          if (!m.id) m.id = 'mov_' + Math.random().toString(36).slice(2);
          return m;
        });
        renderAll();
        updateSelects();
        autoSaveData();
        alert('Adatok visszatöltve!');
      } catch(err) {
        alert('Hibás fájl!');
      }
    };
    reader.readAsText(fileInput.files[0]);
  }

  /* ==== SZŰRŐK JAVÍTÁSA (checkbox tényleg kattintható) ==== */
  function openFilter(tableId, colKey, ev) {
    ev.stopPropagation();
    closeAllFilters();

    const th = ev.target.closest('th');
    const dropdown = document.createElement('div');
    dropdown.className = 'filter-dropdown';
    dropdown.dataset.table = tableId;
    dropdown.dataset.col = colKey;

    // aktuálisan kirajzolt sorok
    const rows = lastRendered[tableId] || [];

    // lehetséges értékek
    let values = [];
    switch (tableId) {
      case 'inventory-table':
      case 'income-inventory-table':
      case 'expense-inventory-table':
        if (colKey === 'type') values = [...new Set(rows.map(r => r.type))].sort((a,b)=>a.localeCompare(b));
        if (colKey === 'size') values = [...new Set(rows.map(r => r.size))].sort((a,b)=>sizeRank(a)-sizeRank(b)||a.localeCompare(b));
        break;
      case 'base-products-table':
        if (colKey === 'type') values = [...new Set(rows.map(r => r.type))].sort((a,b)=>a.localeCompare(b));
        if (colKey === 'size') values = [...new Set(rows.map(r => r.size || '-'))].sort((a,b)=>a.localeCompare(b));
        break;
      case 'employees-table':
        if (colKey === 'name') values = [...new Set(rows.map(r => r.name))].sort((a,b)=>a.localeCompare(b));
        break;
      case 'movements-table':
        if (colKey === 'employee') values = [...new Set(rows.map(r => r.employee || '-'))].sort((a,b)=>a.localeCompare(b));
        if (colKey === 'type') values = [...new Set(rows.map(r => r.type))].sort((a,b)=>a.localeCompare(b));
        if (colKey === 'size') values = [...new Set(rows.map(r => r.size || ''))].filter(Boolean).sort((a,b)=>sizeRank(a)-sizeRank(b)||a.localeCompare(b));
        break;
    }

    const active = (tableFilters[tableId] && tableFilters[tableId][colKey]) ? new Set(tableFilters[tableId][colKey]) : null;

    values.forEach(v => {
      const lbl = document.createElement('label');
      lbl.addEventListener('click', e => e.stopPropagation());   // <<< EZ A FONTOS
      const checked = !active || active.has(v);
      lbl.innerHTML = `<input type="checkbox" value="${v}" ${checked ? 'checked' : ''}> ${v || '(üres)'}`;
      const inp = lbl.querySelector('input');
      inp.addEventListener('click', e => e.stopPropagation());   // <<< EZ A MÁSODIK FONTOS
      dropdown.appendChild(lbl);
    });

    const act = document.createElement('div');
    act.className = 'filter-actions';
    const ok = document.createElement('button');
    ok.textContent = 'OK';
    const clr = document.createElement('button');
    clr.textContent = 'Töröl';
    clr.style.background = '#d1d5db';
    act.appendChild(clr);
    act.appendChild(ok);
    dropdown.appendChild(act);

    ok.onclick = e => {
      e.stopPropagation();
      const checks = dropdown.querySelectorAll('input[type=checkbox]');
      const chosen = [];
      checks.forEach(c => { if (c.checked) chosen.push(c.value); });
      if (!tableFilters[tableId]) tableFilters[tableId] = {};
      tableFilters[tableId][colKey] = chosen;
      refreshTableById(tableId);
      dropdown.remove();
    };
    clr.onclick = e => {
      e.stopPropagation();
      if (!tableFilters[tableId]) tableFilters[tableId] = {};
      delete tableFilters[tableId][colKey];
      refreshTableById(tableId);
      dropdown.remove();
    };

    th.appendChild(dropdown);
  }

  function closeAllFilters() {
    document.querySelectorAll('.filter-dropdown').forEach(d => d.remove());
  }

  // csak akkor zárjuk, ha NEM a filterre kattintott
  document.addEventListener('click', e => {
    if (!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-btn')) {
      closeAllFilters();
    }
  });

  // táblák újrarajzolása szűrés után
  function refreshTableById(tableId) {
    switch (tableId) {
      case 'inventory-table':
      case 'income-inventory-table':
      case 'expense-inventory-table':
        renderInventoryTable(tableId);
        break;
      case 'base-products-table':
        renderBaseProducts();
        break;
      case 'employees-table':
        renderEmployees();
        break;
      case 'movements-table':
        renderMovements();
        break;
    }
  }

  // adatalapú szűrés
  function applyDataFilters(tableId, rows, mapFns) {
    const tf = tableFilters[tableId];
    if (!tf) return rows;
    return rows.filter(r => {
      for (const col in tf) {
        const selected = tf[col];
        if (selected && selected.length) {
          const val = mapFns[col] ? mapFns[col](r) : '';
          if (!selected.includes(val)) return false;
        }
      }
      return true;
    });
  }
</script>
</body>
</html>
